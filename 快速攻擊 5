-- ================= 基本設定 =================
_G.FastAttack = true

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Player = Players.LocalPlayer

-- CombatFramework（核心）
local CombatFramework = require(Player.PlayerScripts:WaitForChild("CombatFramework"))
local CombatController = CombatFramework.CombatController

local EnemiesFolder = workspace:WaitForChild("Enemies")

-- ================= 設定 =================
local Settings = {
    AutoClick = true,
    Distance = 80,
    AttackInterval = 0.05,
    MaxTargets = 50
}

-- ================= 工具函數 =================
local function GetCharacter()
    return Player.Character or Player.CharacterAdded:Wait()
end

local function GetWeapon()
    local char = GetCharacter()
    return char and char:FindFirstChildOfClass("Tool")
end

local function IsAlive(model)
    local hum = model:FindFirstChild("Humanoid")
    return hum and hum.Health > 0
end

-- GUI 建立
local PlayerGui = Player:WaitForChild("PlayerGui")
if PlayerGui:FindFirstChild("FastAttackGUI") then
    PlayerGui.FastAttackGUI:Destroy()
end

local gui = Instance.new("ScreenGui")
gui.Name = "FastAttackGUI"
gui.ResetOnSpawn = false
gui.Parent = PlayerGui

local frame = Instance.new("Frame")
frame.Size = UDim2.fromOffset(420, 220)
frame.Position = UDim2.fromOffset(100, 100)
frame.BackgroundColor3 = Color3.fromRGB(40,40,40)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
frame.Parent = gui

-- 標題
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -60, 0, 30)
title.Position = UDim2.new(0, 0, 0, 0)
title.BackgroundTransparency = 1
title.Text = "布魯斯最愛的快速攻擊"
title.TextColor3 = Color3.fromRGB(255,255,255)
title.TextScaled = true
title.Parent = frame

-- 關閉按鈕
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.fromOffset(30, 30)
closeBtn.Position = UDim2.new(1, -30, 0, 0)
closeBtn.BackgroundColor3 = Color3.fromRGB(200,50,50)
closeBtn.TextColor3 = Color3.fromRGB(255,255,255)
closeBtn.Text = "X"
closeBtn.TextScaled = true
closeBtn.Parent = frame
closeBtn.MouseButton1Click:Connect(function()
    gui:Destroy()
end)

-- 縮小按鈕
local minimizeBtn = Instance.new("TextButton")
minimizeBtn.Size = UDim2.fromOffset(30,30)
minimizeBtn.Position = UDim2.new(1, -60, 0, 0)
minimizeBtn.BackgroundColor3 = Color3.fromRGB(100,100,100)
minimizeBtn.TextColor3 = Color3.fromRGB(255,255,255)
minimizeBtn.Text = "-"
minimizeBtn.TextScaled = true
minimizeBtn.Parent = frame

local minimizedFrame = nil
local function minimize()
    frame.Visible = false
    minimizedFrame = Instance.new("TextButton")
    minimizedFrame.Size = UDim2.fromOffset(50,50)
    minimizedFrame.Position = frame.Position
    minimizedFrame.BackgroundColor3 = Color3.fromRGB(0,0,0)  -- 黑底
    minimizedFrame.BorderSizePixel = 0
    minimizedFrame.Text = "ez"
    minimizedFrame.TextColor3 = Color3.fromRGB(255,255,255)   -- 白字
    minimizedFrame.TextScaled = true
    minimizedFrame.Parent = gui
    minimizedFrame.MouseButton1Click:Connect(function()
        frame.Visible = true
        minimizedFrame:Destroy()
        minimizedFrame = nil
    end)
end

minimizeBtn.MouseButton1Click:Connect(minimize)

-- 自動攻擊開關
local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(1,-20,0,40)
toggleBtn.Position = UDim2.new(0,10,0,40)
toggleBtn.BackgroundColor3 = Color3.fromRGB(70,70,70)
toggleBtn.TextColor3 = Color3.fromRGB(255,255,255)
toggleBtn.TextScaled = true
toggleBtn.Text = "自動攻擊: 開"
toggleBtn.Parent = frame
toggleBtn.MouseButton1Click:Connect(function()
    Settings.AutoClick = not Settings.AutoClick
    toggleBtn.Text = "自動攻擊: "..(Settings.AutoClick and "開啟" or "關閉")
end)

-- 攻擊距離標籤
local label = Instance.new("TextLabel")
label.Size = UDim2.new(0,150,0,25)
label.Position = UDim2.new(0,10,0,90)
label.BackgroundTransparency = 1
label.TextColor3 = Color3.fromRGB(255,255,0)
label.TextScaled = true
label.Text = "攻擊距離: "..Settings.Distance.." 米"
label.TextXAlignment = Enum.TextXAlignment.Left
label.Parent = frame

-- 輸入框
local inputBox = Instance.new("TextBox")
inputBox.Size = UDim2.new(0,80,0,25)
inputBox.Position = UDim2.new(0,170,0,90)
inputBox.BackgroundColor3 = Color3.fromRGB(70,70,70)
inputBox.TextColor3 = Color3.fromRGB(255,255,255)
inputBox.TextScaled = true
inputBox.ClearTextOnFocus = false
inputBox.Text = tostring(Settings.Distance)
inputBox.Parent = frame

-- 最大值提示
local maxLabel = Instance.new("TextLabel")
maxLabel.Size = UDim2.new(0,100,0,25)
maxLabel.Position = UDim2.new(0,260,0,90)
maxLabel.BackgroundTransparency = 1
maxLabel.TextColor3 = Color3.fromRGB(200,200,200)
maxLabel.TextScaled = true
maxLabel.Text = "(max:9999 米)"
maxLabel.TextXAlignment = Enum.TextXAlignment.Left
maxLabel.Parent = frame

-- 滑桿
local slider = Instance.new("Frame")
slider.Size = UDim2.new(1,-40,0,30)
slider.Position = UDim2.new(0,10,0,130)
slider.BackgroundColor3 = Color3.fromRGB(100,100,100)
slider.BorderSizePixel = 0
slider.Parent = frame

distBox.FocusLost:Connect(function()
    local v = tonumber(distBox.Text)
    if v then
        Settings.Distance = math.clamp(v, 10, 200)
        distLabel.Text = "攻擊距離：" .. Settings.Distance
    end
end)

-- ================= FastAttack 核心（無 Remote） =================
task.spawn(function()
    while task.wait(Settings.AttackInterval) do
        if not _G.FastAttack or not Settings.AutoClick then
            continue
        end

        local char = GetCharacter()
        local weapon = GetWeapon()
        if not char or not weapon then
            continue
        end

        if not CombatController or not CombatController.activeController then
            continue
        end

        local ac = CombatController.activeController

        -- 解鎖冷卻 & 距離
        ac.timeToNextAttack = 0
        ac.hitboxMagnitude = Settings.Distance
        ac.increment = 1
        ac.focusStart = 0
        ac.focusEnd = 0

        -- 收集敵人
        local targets = {}
        for _, enemy in ipairs(EnemiesFolder:GetChildren()) do
            if IsAlive(enemy) then
                table.insert(targets, enemy)
                if #targets >= Settings.MaxTargets then
                    break
                end
            end
        end

        if #targets == 0 then
            continue
        end

        ac.hitTargets = targets
        ac.currentAttackTrack = ac.anims.basic[1]

        pcall(function()
            ac:attack()
        end)
    end
end)
