-- ===== 基本服務 =====
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")

-- ===== 飛行設定 =====
local flying = false
local speed = 0
local maxSpeed = 80
local acceleration = 200
local deceleration = 300
local moveDirection = Vector3.new(0,0,0)

-- ===== 按鍵開關 =====
UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end

    if input.KeyCode == Enum.KeyCode.E then
        flying = not flying
        humanoid.PlatformStand = flying
        if not flying then
            humanoidRootPart.Velocity = Vector3.new(0,0,0)
        end
    end

    -- 飛行方向
    if input.KeyCode == Enum.KeyCode.W then moveDirection = moveDirection + Vector3.new(0,0,-1) end
    if input.KeyCode == Enum.KeyCode.S then moveDirection = moveDirection + Vector3.new(0,0,1) end
    if input.KeyCode == Enum.KeyCode.A then moveDirection = moveDirection + Vector3.new(-1,0,0) end
    if input.KeyCode == Enum.KeyCode.D then moveDirection = moveDirection + Vector3.new(1,0,0) end
    if input.KeyCode == Enum.KeyCode.Space then moveDirection = moveDirection + Vector3.new(0,1,0) end
    if input.KeyCode == Enum.KeyCode.LeftShift then moveDirection = moveDirection + Vector3.new(0,-1,0) end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.W then moveDirection = moveDirection - Vector3.new(0,0,-1) end
    if input.KeyCode == Enum.KeyCode.S then moveDirection = moveDirection - Vector3.new(0,0,1) end
    if input.KeyCode == Enum.KeyCode.A then moveDirection = moveDirection - Vector3.new(-1,0,0) end
    if input.KeyCode == Enum.KeyCode.D then moveDirection = moveDirection - Vector3.new(1,0,0) end
    if input.KeyCode == Enum.KeyCode.Space then moveDirection = moveDirection - Vector3.new(0,1,0) end
    if input.KeyCode == Enum.KeyCode.LeftShift then moveDirection = moveDirection - Vector3.new(0,-1,0) end
end)

-- ===== 飛行邏輯 =====
RunService.RenderStepped:Connect(function(deltaTime)
    if flying then
        local cam = workspace.CurrentCamera
        local dir = Vector3.new(0,0,0)

        -- 計算方向
        if moveDirection.Magnitude > 0 then
            local forward = cam.CFrame.LookVector
            local right = cam.CFrame.RightVector
            dir = (forward * moveDirection.Z + right * moveDirection.X + Vector3.new(0,1,0) * moveDirection.Y).Unit
        end

        -- 加速度控制
        if dir.Magnitude > 0 then
            speed = math.min(speed + acceleration * deltaTime, maxSpeed)
        else
            speed = math.max(speed - deceleration * deltaTime, 0)
        end

        -- 設置速度
        humanoidRootPart.Velocity = dir * speed
    end
end)
