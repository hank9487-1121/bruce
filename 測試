-- ====== 基本服務 ======
local Players = game:GetService("Players")
local Player = Players.LocalPlayer

-- ====== CombatFramework ======
local CombatFramework = require(Player.PlayerScripts:WaitForChild("CombatFramework"))
local CombatController = CombatFramework.CombatController

-- ====== 設定 ======
local Settings = {
    HitboxRadius = 9999, -- 攻擊距離
    Enabled = true
}

-- ====== 角色 ======
local function GetCharacter()
    return Player.Character or Player.CharacterAdded:Wait()
end

local function IsAlive(char)
    local hum = char:FindFirstChild("Humanoid")
    return hum and hum.Health > 0
end

-- ====== 抓敵人 ======
local function GetEnemiesInRange()
    local results = {}
    local char = GetCharacter()
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if not hrp then return results end

    for _, v in pairs(workspace:GetChildren()) do
        if v:IsA("Model")
            and v ~= char
            and IsAlive(v)
            and v:FindFirstChild("HumanoidRootPart") then

            local dist = (hrp.Position - v.HumanoidRootPart.Position).Magnitude
            if dist <= Settings.HitboxRadius then
                table.insert(results, v)
            end
        end
    end

    return results
end

-- ====== 核心：攔截目標取得 ======
local oldGetTargets
oldGetTargets = hookfunction(
    CombatController.getTargets,
    function(self, ...)
        if not Settings.Enabled then
            return oldGetTargets(self, ...)
        end

        -- 原本會拿到的 targets
        local targets = oldGetTargets(self, ...)
        local extraTargets = GetEnemiesInRange()

        -- 合併目標（避免重複）
        local map = {}
        for _, v in pairs(targets or {}) do
            map[v] = true
        end

        for _, v in pairs(extraTargets) do
            if not map[v] then
                table.insert(targets, v)
            end
        end

        return targets
    end
)

-- ====== 簡易開關 ======
local PlayerGui = Player:WaitForChild("PlayerGui")
local gui = Instance.new("ScreenGui", PlayerGui)
gui.Name = "HitboxGUI"
gui.ResetOnSpawn = false

local btn = Instance.new("TextButton", gui)
btn.Size = UDim2.new(0, 160, 0, 50)
btn.Position = UDim2.new(0, 20, 0, 20)
btn.Text = "Hitbox: ON"
btn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
btn.TextColor3 = Color3.new(1,1,1)

btn.MouseButton1Click:Connect(function()
    Settings.Enabled = not Settings.Enabled
    btn.Text = "Hitbox: " .. (Settings.Enabled and "ON" or "OFF")
    btn.BackgroundColor3 = Settings.Enabled
        and Color3.fromRGB(50,200,50)
        or Color3.fromRGB(200,50,50)
end)

