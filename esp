-- ===== 服務 =====
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local LocalPlayer = Players.LocalPlayer

-- ===== 設定 =====
local PLAYER_ESP_ENABLED = true
local PLAYER_TOGGLE_KEY = Enum.KeyCode.F  -- 按 F 開關玩家 ESP

local NAME_SIZE = 18
local SELF_NAME_COLOR = Color3.fromRGB(80, 200, 255)
local ENEMY_NAME_COLOR = Color3.fromRGB(255, 80, 80)
local SELF_HP_COLOR = Color3.fromRGB(80, 255, 200)
local ENEMY_HP_COLOR_START = Color3.fromRGB(255, 60, 60)
local ENEMY_HP_COLOR_END = Color3.fromRGB(0, 255, 80)

-- ===== ESP 容器 =====
local EspFolder = Instance.new("Folder")
EspFolder.Name = "PlayerESP"
EspFolder.Parent = game.CoreGui

-- ===== 螢幕提示 =====
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ESP_Notify"
screenGui.ResetOnSpawn = false
screenGui.Parent = game.CoreGui

local label = Instance.new("TextLabel")
label.AnchorPoint = Vector2.new(0.5, 0)
label.Position = UDim2.new(0.5, 0, 0.12, 0)
label.Size = UDim2.new(0, 240, 0, 42)
label.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
label.BackgroundTransparency = 0.2
label.TextTransparency = 1
label.TextStrokeTransparency = 1
label.Font = Enum.Font.SourceSansBold
label.TextSize = 22
label.TextColor3 = Color3.fromRGB(255, 255, 255)
label.Text = ""
label.Visible = false
label.Parent = screenGui
Instance.new("UICorner", label).CornerRadius = UDim.new(0, 12)

local function showESPNotify(state)
	label.Visible = true
	label.Text = state and "PLAYER ESP : ON" or "PLAYER ESP : OFF"
	label.TextColor3 = state and Color3.fromRGB(80, 255, 180) or Color3.fromRGB(255, 80, 80)
	label.BackgroundTransparency = 0.2
	label.TextTransparency = 0
	label.TextStrokeTransparency = 0

	task.delay(1.2, function()
		local tween = TweenService:Create(
			label,
			TweenInfo.new(0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
			{TextTransparency = 1, TextStrokeTransparency = 1, BackgroundTransparency = 1}
		)
		tween:Play()
		tween.Completed:Once(function()
			label.Visible = false
		end)
	end)
end

-- ===== 玩家 ESP 建立函式 =====
local function createPlayerESP(player)
	local gui = Instance.new("BillboardGui")
	gui.Size = UDim2.new(0, 140, 0, 50)
	gui.StudsOffset = Vector3.new(0, 3, 0)
	gui.AlwaysOnTop = true
	gui.Name = player.Name .. "_ESP"
	gui.Parent = EspFolder

	local nameLabel = Instance.new("TextLabel")
	nameLabel.Size = UDim2.new(1, 0, 0.5, 0)
	nameLabel.BackgroundTransparency = 1
	nameLabel.Font = Enum.Font.SourceSansBold
	nameLabel.TextSize = NAME_SIZE
	nameLabel.TextStrokeTransparency = 0
	nameLabel.Parent = gui

	local hpBack = Instance.new("Frame")
	hpBack.Size = UDim2.new(1, 0, 0.18, 0)
	hpBack.Position = UDim2.new(0, 0, 0.65, 0)
	hpBack.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
	hpBack.BorderSizePixel = 0
	hpBack.Parent = gui
	Instance.new("UICorner", hpBack).CornerRadius = UDim.new(0, 6)

	local hpBar = Instance.new("Frame")
	hpBar.Size = UDim2.new(1, 0, 1, 0)
	hpBar.BackgroundColor3 = SELF_HP_COLOR
	hpBar.BorderSizePixel = 0
	hpBar.Parent = hpBack
	Instance.new("UICorner", hpBar).CornerRadius = UDim.new(0, 6)

	RunService.RenderStepped:Connect(function()
		if not PLAYER_ESP_ENABLED then
			gui.Enabled = false
			return
		end

		local char = player.Character
		local myChar = LocalPlayer.Character
		if char and myChar and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChild("Humanoid") then
			local hrp = char.HumanoidRootPart
			local hum = char.Humanoid
			gui.Adornee = hrp
			gui.Enabled = true

			local dist = math.floor((myChar.HumanoidRootPart.Position - hrp.Position).Magnitude)
			local isSelf = (player == LocalPlayer)

			-- 名字顏色
			nameLabel.TextColor3 = isSelf and SELF_NAME_COLOR or ENEMY_NAME_COLOR
			nameLabel.Text = player.Name .. " [" .. dist .. "m]"

			-- 血量條
			local hpPercent = math.clamp(hum.Health / hum.MaxHealth, 0, 1)
			hpBar.Size = UDim2.new(hpPercent, 0, 1, 0)
			hpBar.BackgroundColor3 = isSelf and SELF_HP_COLOR or ENEMY_HP_COLOR_START:Lerp(ENEMY_HP_COLOR_END, hpPercent)
		else
			gui.Enabled = false
		end
	end)
end

-- ===== 初始化玩家 ESP =====
for _, plr in ipairs(Players:GetPlayers()) do
	createPlayerESP(plr)
end

Players.PlayerAdded:Connect(createPlayerESP)

-- ===== 玩家 ESP 開關 =====
UserInputService.InputBegan:Connect(function(input, gp)
	if gp then return end
	if input.KeyCode == PLAYER_TOGGLE_KEY then
		PLAYER_ESP_ENABLED = not PLAYER_ESP_ENABLED
		showESPNotify(PLAYER_ESP_ENABLED)
	end
end)
