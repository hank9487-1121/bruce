-- ===== 服務 =====
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer

-- ===== 設定 =====
local ESP_ENABLED = true
local NAME_COLOR = Color3.fromRGB(255, 255, 255)
local HP_GREEN = Color3.fromRGB(0, 255, 80)
local HP_RED = Color3.fromRGB(255, 60, 60)

-- ===== ESP 容器 =====
local EspFolder = Instance.new("Folder")
EspFolder.Name = "ESP"
EspFolder.Parent = game.CoreGui

-- ===== 建立 ESP =====
local function createESP(player)
	if player == LocalPlayer then return end

	-- Billboard
	local gui = Instance.new("BillboardGui")
	gui.Size = UDim2.new(0, 140, 0, 50)
	gui.StudsOffset = Vector3.new(0, 3, 0)
	gui.AlwaysOnTop = true
	gui.Name = player.Name .. "_ESP"
	gui.Parent = EspFolder

	-- 名字
	local nameLabel = Instance.new("TextLabel")
	nameLabel.Size = UDim2.new(1, 0, 0.5, 0)
	nameLabel.BackgroundTransparency = 1
	nameLabel.TextColor3 = NAME_COLOR
	nameLabel.TextStrokeTransparency = 0
	nameLabel.Font = Enum.Font.SourceSansBold
	nameLabel.TextSize = 18
	nameLabel.Parent = gui

	-- 血量底條
	local hpBack = Instance.new("Frame")
	hpBack.Size = UDim2.new(1, 0, 0.18, 0)
	hpBack.Position = UDim2.new(0, 0, 0.65, 0)
	hpBack.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
	hpBack.BorderSizePixel = 0
	hpBack.Parent = gui

	local corner = Instance.new("UICorner", hpBack)
	corner.CornerRadius = UDim.new(0, 6)

	-- 血量條
	local hpBar = Instance.new("Frame")
	hpBar.Size = UDim2.new(1, 0, 1, 0)
	hpBar.BackgroundColor3 = HP_GREEN
	hpBar.BorderSizePixel = 0
	hpBar.Parent = hpBack

	local corner2 = Instance.new("UICorner", hpBar)
	corner2.CornerRadius = UDim.new(0, 6)

	-- 更新
	RunService.RenderStepped:Connect(function()
		if not ESP_ENABLED then
			gui.Enabled = false
			return
		end

		local char = player.Character
		local myChar = LocalPlayer.Character
		if char and myChar and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChild("Humanoid") then
			local hrp = char.HumanoidRootPart
			local hum = char.Humanoid

			gui.Adornee = hrp
			gui.Enabled = true

			local dist = math.floor(
				(myChar.HumanoidRootPart.Position - hrp.Position).Magnitude
			)

			nameLabel.Text = player.Name .. " [" .. dist .. "m]"

			local hpPercent = math.clamp(hum.Health / hum.MaxHealth, 0, 1)
			hpBar.Size = UDim2.new(hpPercent, 0, 1, 0)
			hpBar.BackgroundColor3 = HP_RED:Lerp(HP_GREEN, hpPercent)
		else
			gui.Enabled = false
		end
	end)
end

-- ===== 初始化 =====
for _, plr in ipairs(Players:GetPlayers()) do
	createESP(plr)
end

Players.PlayerAdded:Connect(createESP)

-- ===== NPC / 人偶 ESP =====
local Workspace = game:GetService("Workspace")

local function createNPCEsp(model)
	if not model:IsA("Model") then return end
	if model:FindFirstChildOfClass("Humanoid") == nil then return end
	if model:FindFirstChild("HumanoidRootPart") == nil then return end
	if Players:GetPlayerFromCharacter(model) then return end -- 排除玩家

	local hum = model:FindFirstChildOfClass("Humanoid")
	local hrp = model.HumanoidRootPart

	local gui = Instance.new("BillboardGui")
	gui.Size = UDim2.new(0, 140, 0, 50)
	gui.StudsOffset = Vector3.new(0, 3, 0)
	gui.AlwaysOnTop = true
	gui.Adornee = hrp
	gui.Parent = EspFolder

	local nameLabel = Instance.new("TextLabel")
	nameLabel.Size = UDim2.new(1, 0, 0.5, 0)
	nameLabel.BackgroundTransparency = 1
	nameLabel.TextStrokeTransparency = 0
	nameLabel.Font = Enum.Font.SourceSansBold
	nameLabel.TextSize = 18
	nameLabel.TextColor3 = Color3.fromRGB(255, 200, 80)
	nameLabel.Text = model.Name .. " [NPC]"
	nameLabel.Parent = gui

	local hpBack = Instance.new("Frame")
	hpBack.Size = UDim2.new(1, 0, 0.18, 0)
	hpBack.Position = UDim2.new(0, 0, 0.65, 0)
	hpBack.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
	hpBack.BorderSizePixel = 0
	hpBack.Parent = gui

	Instance.new("UICorner", hpBack).CornerRadius = UDim.new(0, 6)

	local hpBar = Instance.new("Frame")
	hpBar.Size = UDim2.new(1, 0, 1, 0)
	hpBar.BackgroundColor3 = Color3.fromRGB(0, 255, 80)
	hpBar.BorderSizePixel = 0
	hpBar.Parent = hpBack

	Instance.new("UICorner", hpBar).CornerRadius = UDim.new(0, 6)

	RunService.RenderStepped:Connect(function()
		if hum.Health <= 0 then
			gui.Enabled = false
			return
		end

		local percent = math.clamp(hum.Health / hum.MaxHealth, 0, 1)
		hpBar.Size = UDim2.new(percent, 0, 1, 0)
		hpBar.BackgroundColor3 =
			Color3.fromRGB(255, 60, 60):Lerp(Color3.fromRGB(0, 255, 80), percent)
	end)
end

-- 掃描現有人偶
for _, obj in ipairs(Workspace:GetDescendants()) do
	createNPCEsp(obj)
end

-- 新生成的人偶
Workspace.DescendantAdded:Connect(createNPCEsp)
