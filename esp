-- ===== 服務 =====
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer

-- ===== ESP 狀態提示 UI =====
local TweenService = game:GetService("TweenService")

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ESP_Notify"
screenGui.ResetOnSpawn = false
screenGui.Parent = game.CoreGui

local label = Instance.new("TextLabel")
label.AnchorPoint = Vector2.new(0.5, 0)
label.Position = UDim2.new(0.5, 0, 0.12, 0)
label.Size = UDim2.new(0, 240, 0, 42)
label.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
label.BackgroundTransparency = 0.2
label.TextTransparency = 1
label.TextStrokeTransparency = 1
label.Font = Enum.Font.SourceSansBold
label.TextSize = 22
label.TextColor3 = Color3.fromRGB(255, 255, 255)
label.Text = ""
label.Visible = false
label.Parent = screenGui

Instance.new("UICorner", label).CornerRadius = UDim.new(0, 12)

local function showESPNotify(state)
	label.Visible = true
	label.Text = state and "ESP : ON" or "ESP : OFF"

	label.TextColor3 = state
		and Color3.fromRGB(80, 255, 180)
		or Color3.fromRGB(255, 80, 80)

	label.BackgroundTransparency = 0.2
	label.TextTransparency = 0
	label.TextStrokeTransparency = 0

	-- 淡出
	task.delay(1.2, function()
		local tween = TweenService:Create(
			label,
			TweenInfo.new(0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
			{
				TextTransparency = 1,
				TextStrokeTransparency = 1,
				BackgroundTransparency = 1
			}
		)
		tween:Play()
		tween.Completed:Once(function()
			label.Visible = false
		end)
	end)
end

-- ===== 設定 =====
local ESP_ENABLED = true
local NAME_COLOR = Color3.fromRGB(255, 255, 255)
local HP_GREEN = Color3.fromRGB(0, 255, 80)
local HP_RED = Color3.fromRGB(255, 60, 60)

-- ===== ESP 容器 =====
local EspFolder = Instance.new("Folder")
EspFolder.Name = "ESP"
EspFolder.Parent = game.CoreGui

-- ===== 建立 ESP =====
local function createESP(player)
	if player == LocalPlayer then return end

	-- Billboard
	local gui = Instance.new("BillboardGui")
	gui.Size = UDim2.new(0, 140, 0, 50)
	gui.StudsOffset = Vector3.new(0, 3, 0)
	gui.AlwaysOnTop = true
	gui.Name = player.Name .. "_ESP"
	gui.Parent = EspFolder

	-- 名字
	local nameLabel = Instance.new("TextLabel")
	nameLabel.Size = UDim2.new(1, 0, 0.5, 0)
	nameLabel.BackgroundTransparency = 1
	nameLabel.TextColor3 = NAME_COLOR
	nameLabel.TextStrokeTransparency = 0
	nameLabel.Font = Enum.Font.SourceSansBold
	nameLabel.TextSize = 18
	nameLabel.Parent = gui

	-- 血量底條
	local hpBack = Instance.new("Frame")
	hpBack.Size = UDim2.new(1, 0, 0.18, 0)
	hpBack.Position = UDim2.new(0, 0, 0.65, 0)
	hpBack.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
	hpBack.BorderSizePixel = 0
	hpBack.Parent = gui

	local corner = Instance.new("UICorner", hpBack)
	corner.CornerRadius = UDim.new(0, 6)

	-- 血量條
	local hpBar = Instance.new("Frame")
	hpBar.Size = UDim2.new(1, 0, 1, 0)
	hpBar.BackgroundColor3 = HP_GREEN
	hpBar.BorderSizePixel = 0
	hpBar.Parent = hpBack

	local corner2 = Instance.new("UICorner", hpBar)
	corner2.CornerRadius = UDim.new(0, 6)

	-- 更新
	RunService.RenderStepped:Connect(function()
		if not ESP_ENABLED then
			gui.Enabled = false
			return
		end

		local char = player.Character
		local myChar = LocalPlayer.Character
		if char and myChar and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChild("Humanoid") then
			local hrp = char.HumanoidRootPart
			local hum = char.Humanoid

			gui.Adornee = hrp
			gui.Enabled = true

			local dist = math.floor(
				(myChar.HumanoidRootPart.Position - hrp.Position).Magnitude
			)

			nameLabel.Text = player.Name .. " [" .. dist .. "m]"

			local hpPercent = math.clamp(hum.Health / hum.MaxHealth, 0, 1)
			hpBar.Size = UDim2.new(hpPercent, 0, 1, 0)
			hpBar.BackgroundColor3 = HP_RED:Lerp(HP_GREEN, hpPercent)
		else
			gui.Enabled = false
		end
	end)
end

-- ===== 初始化 =====
for _, plr in ipairs(Players:GetPlayers()) do
	createESP(plr)
end

Players.PlayerAdded:Connect(createESP)
 
