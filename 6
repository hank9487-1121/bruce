-- ================= 基本設定 =================
_G.FastAttack = true
_G.AutoRace = false

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local Player = Players.LocalPlayer

local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RegisterAttack = Net:WaitForChild("RE/RegisterAttack")
local RegisterHit = Net:WaitForChild("RE/RegisterHit")
local EnemiesFolder = workspace:WaitForChild("Enemies")
local CharactersFolder = workspace:WaitForChild("Characters")

local Settings = {
    AutoClick = true,
    Distance = 0,
    AttackInterval = 0.001,
    MaxTargets = 50
}

local function IsAlive(char)
    local hum = char:FindFirstChild("Humanoid")
    return hum and hum.Health > 0
end

-- ================= GUI =================
local PlayerGui = Player:WaitForChild("PlayerGui")
if PlayerGui:FindFirstChild("FastAttackGUI") then
    PlayerGui.FastAttackGUI:Destroy()
end

local gui = Instance.new("ScreenGui", PlayerGui)
gui.Name = "FastAttackGUI"
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.fromOffset(420, 260)
frame.Position = UDim2.fromOffset(100, 100)
frame.BackgroundColor3 = Color3.fromRGB(40,40,40)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,12)

-- 標題
local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1, -60, 0, 30)
title.BackgroundTransparency = 1
title.Text = "布魯斯最愛的快速攻擊"
title.TextColor3 = Color3.fromRGB(255,255,255)
title.TextScaled = true

-- 關閉
local closeBtn = Instance.new("TextButton", frame)
closeBtn.Size = UDim2.fromOffset(30, 30)
closeBtn.Position = UDim2.new(1, -30, 0, 0)
closeBtn.Text = "X"
closeBtn.TextScaled = true
closeBtn.BackgroundColor3 = Color3.fromRGB(200,50,50)
closeBtn.TextColor3 = Color3.new(1,1,1)
closeBtn.MouseButton1Click:Connect(function()
    gui:Destroy()
end)

-- ================= 自動攻擊 =================
local toggleBtn = Instance.new("TextButton", frame)
toggleBtn.Size = UDim2.new(1,-20,0,40)
toggleBtn.Position = UDim2.new(0,10,0,40)
toggleBtn.BackgroundColor3 = Color3.fromRGB(70,70,70)
toggleBtn.TextColor3 = Color3.new(1,1,1)
toggleBtn.TextScaled = true
toggleBtn.Text = "自動攻擊：開啟"
toggleBtn.MouseButton1Click:Connect(function()
    Settings.AutoClick = not Settings.AutoClick
    toggleBtn.Text = "自動攻擊：" .. (Settings.AutoClick and "開啟" or "關閉")
end)

-- ================= 種族 V3 / V4 =================
local raceBtn = Instance.new("TextButton", frame)
raceBtn.Size = UDim2.new(1,-20,0,40)
raceBtn.Position = UDim2.new(0,10,0,90)
raceBtn.BackgroundColor3 = Color3.fromRGB(70,70,70)
raceBtn.TextColor3 = Color3.new(1,1,1)
raceBtn.TextScaled = true
raceBtn.Text = "自動種族 V3 / V4：關閉"

raceBtn.MouseButton1Click:Connect(function()
    _G.AutoRace = not _G.AutoRace
    raceBtn.Text = "自動種族 V3 / V4：" .. (_G.AutoRace and "開啟" or "關閉")
    raceBtn.BackgroundColor3 = _G.AutoRace and Color3.fromRGB(120,80,200) or Color3.fromRGB(70,70,70)
end)

-- ================= Race Logic =================
local function GetRaceTier()
    local ok,data = pcall(function()
        return require(ReplicatedStorage.Modules.PlayerData).RaceTier
    end)
    return ok and data or 0
end

local function Press(key)
    UserInputService.InputBegan:Fire({KeyCode=key,UserInputType=Enum.UserInputType.Keyboard},false)
    task.wait(0.05)
    UserInputService.InputEnded:Fire({KeyCode=key,UserInputType=Enum.UserInputType.Keyboard},false)
end

task.spawn(function()
    while true do
        if _G.AutoRace then
            local tier = GetRaceTier()
            if tier >= 3 then Press(Enum.KeyCode.T) end
            if tier >= 4 then Press(Enum.KeyCode.Y) end
        end
        task.wait(1)
    end
end)

-- ================= 核心攻擊 =================
task.spawn(function()
    while _G.FastAttack do
        if Settings.AutoClick then
            local root = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
            if root then
                local targets = {}
                for _, folder in ipairs({EnemiesFolder, CharactersFolder}) do
                    for _, obj in ipairs(folder:GetChildren()) do
                        if obj ~= Player.Character then
                            local head = obj:FindFirstChild("Head")
                            if head and IsAlive(obj) then
                                local dist = (head.Position - root.Position).Magnitude
                                if dist <= Settings.Distance then
                                    table.insert(targets,{obj,head})
                                    if #targets >= Settings.MaxTargets then break end
                                end
                            end
                        end
                    end
                    if #targets >= Settings.MaxTargets then break end
                end

                if #targets > 0 then
                    RegisterAttack:FireServer(0)
                    RegisterHit:FireServer(targets[1][2], targets)
                end
            end
        end
        task.wait(Settings.AttackInterval)
    end
end)
