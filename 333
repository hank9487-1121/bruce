-- ===== Xeno Auto V4 =====
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local toggleKey = "自动v4"
local autoV4Task

-- Toggle 狀態
local function getToggleState()
    _G.ToggleStates = _G.ToggleStates or {}
    return _G.ToggleStates[toggleKey] == true
end

-- 取得 Awakening Tool
local function getAwakening()
    local char = LocalPlayer.Character
    local backpack = LocalPlayer:FindFirstChild("Backpack")

    if char then
        local tool = char:FindFirstChild("Awakening")
        if tool then return tool end
    end

    if backpack then
        local tool = backpack:FindFirstChild("Awakening")
        if tool then return tool end
    end
end

-- Xeno 專用啟動方式
local function activateV4()
    local tool = getAwakening()
    local char = LocalPlayer.Character
    if not tool or not char then return end

    pcall(function()
        -- 確保裝備
        tool.Parent = char
        task.wait(0.05)

        -- 模擬正常使用
        tool:Activate()

        -- 有些版本需要重觸一次
        task.wait(0.1)
        tool:Deactivate()
    end)
end

-- 控制循環
local function toggleAutoV4(enable)
    if autoV4Task then
        task.cancel(autoV4Task)
        autoV4Task = nil
    end

    if enable then
        autoV4Task = task.spawn(function()
            while getToggleState() do
                activateV4()
                task.wait(1.3) -- Xeno 不要太快
            end
            autoV4Task = nil
        end)
    end
end

-- UI
Tabs.GeneralTab:Toggle({
    Title = "自動 v4（Xeno）",
    Value = false,
    Callback = function(state)
        _G.ToggleStates = _G.ToggleStates or {}
        _G.ToggleStates[toggleKey] = state
        toggleAutoV4(state)
    end
})
