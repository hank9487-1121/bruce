-- ====== 基本服務 ======
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

-- ====== 玩家 ESP ======
Scripts["玩家 ESP"] = {
    Enabled = false,
    _connections = {},
    Func = function(self)
        local NAME_SIZE = 18
        local ENEMY_NAME_COLOR = Color3.fromRGB(255,80,80)
        local ENEMY_HP_COLOR_START = Color3.fromRGB(255,60,60)
        local ENEMY_HP_COLOR_END = Color3.fromRGB(0,255,80)

        local EspFolder = Instance.new("Folder")
        EspFolder.Name = "PlayerESP"
        EspFolder.Parent = PlayerGui

        local function createPlayerESP(player)
            if player == Player then return end
            local gui = Instance.new("BillboardGui")
            gui.Size = UDim2.new(0,140,0,50)
            gui.StudsOffset = Vector3.new(0,3,0)
            gui.AlwaysOnTop = true
            gui.Name = player.Name.."_ESP"
            gui.Parent = EspFolder

            local nameLabel = Instance.new("TextLabel")
            nameLabel.Size = UDim2.new(1,0,0.5,0)
            nameLabel.BackgroundTransparency = 1
            nameLabel.Font = Enum.Font.SourceSansBold
            nameLabel.TextSize = NAME_SIZE
            nameLabel.TextStrokeTransparency = 0
            nameLabel.TextColor3 = ENEMY_NAME_COLOR
            nameLabel.Parent = gui

            local hpBack = Instance.new("Frame")
            hpBack.Size = UDim2.new(1,0,0.18,0)
            hpBack.Position = UDim2.new(0,0,0.65,0)
            hpBack.BackgroundColor3 = Color3.fromRGB(40,40,40)
            hpBack.BorderSizePixel = 0
            hpBack.Parent = gui
            Instance.new("UICorner", hpBack).CornerRadius=UDim.new(0,6)

            local hpBar = Instance.new("Frame")
            hpBar.Size = UDim2.new(1,0,1,0)
            hpBar.BackgroundColor3 = ENEMY_HP_COLOR_START
            hpBar.BorderSizePixel = 0
            hpBar.Parent = hpBack
            Instance.new("UICorner", hpBar).CornerRadius=UDim.new(0,6)

            local conn
            conn = RunService.RenderStepped:Connect(function()
                if not self.Enabled then
                    gui.Enabled = false
                    return
                end
                local char = player.Character
                local myChar = Player.Character
                if char and myChar and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChild("Humanoid") then
                    gui.Adornee = char.HumanoidRootPart
                    gui.Enabled = true
                    local dist = math.floor((myChar.HumanoidRootPart.Position - char.HumanoidRootPart.Position).Magnitude)
                    nameLabel.Text = player.Name.." ["..dist.."m]"
                    local hpPercent = math.clamp(char.Humanoid.Health/char.Humanoid.MaxHealth,0,1)
                    hpBar.Size = UDim2.new(hpPercent,0,1,0)
                    hpBar.BackgroundColor3 = ENEMY_HP_COLOR_START:Lerp(ENEMY_HP_COLOR_END,1-hpPercent)
                else
                    gui.Enabled = false
                end
            end)
            self._connections[player] = conn

            player.AncestryChanged:Connect(function()
                if not player:IsDescendantOf(game) then
                    if conn then conn:Disconnect() end
                    gui:Destroy()
                end
            end)
        end

        for _,plr in ipairs(Players:GetPlayers()) do createPlayerESP(plr) end
        Players.PlayerAdded:Connect(createPlayerESP)
    end,
    StopFunc = function(self)
        self.Enabled = false
        for _,conn in pairs(self._connections) do
            if conn then conn:Disconnect() end
        end
        self._connections = {}
        local espFolder = PlayerGui:FindFirstChild("PlayerESP")
        if espFolder then espFolder:Destroy() end
    end
}

-- ====== 快速攻擊 ======
Scripts["快速攻擊"] = {
    Enabled = false,
    Func = function(self)
        -- 內嵌快速攻擊簡單範例
        self._conn = RunService.RenderStepped:Connect(function()
            if not self.Enabled then return end
            -- 假設快速攻擊是按 F
            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.F, false, game)
            VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.F, false, game)
        end)
    end,
    StopFunc = function(self)
        self.Enabled = false
        if self._conn then self._conn:Disconnect() end
        self._conn = nil
    end
}

-- ====== 自動按 T ======
Scripts["自動v3"] = {
    Enabled = false,
    Func = function(self)
        if self._conn then return end
        self._conn = task.spawn(function()
            while self.Enabled do
                VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.T, false, game)
                task.wait(0.01)
                VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.T, false, game)
                task.wait(0.1)
            end
        end)
    end,
    StopFunc = function(self)
        self.Enabled = false
        self._conn = nil
    end
}

-- ====== 飛行 GUI ======
Scripts["飛行 GUI"] = {
    Enabled=false,
    Func=function(self)
        -- 這裡可以換成你喜歡的飛行 GUI URL
        local success,err=pcall(function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/XNEOFF/FlyGuiV3/main/FlyGuiV3.txt"))()
        end)
        if not success then warn("飛行 GUI 執行失敗:",err) end
    end,
    StopFunc=function(self)
        warn("飛行 GUI 無法自動關閉")
    end
}

-- ====== 自瞄 ======
Scripts["布魯斯最愛的自瞄"] = {
    Enabled=false,
    Func=function(self)
        -- 內嵌簡單自瞄示意
        print("自瞄已啟動")
        -- 你可以放實際自瞄邏輯
    end,
    StopFunc=function(self)
        warn("自瞄無法自動關閉")
    end
}


